# 优化无止境

## 评估阶段

- 各个模块的时钟可单独控制
- 芯片时钟频率选择
- 芯片各种工作模式下的功耗测量
- 芯片各种定时器在不同时钟输入情况下的功耗
- 硬件静态功耗
- 芯片电压等级范围

## 预处理

- 内联函数
- 宏函数

## 将代码或数据放到 RAM

- 频繁运行的代码放 RAM 执行（主程序，中断服务程序）
- 中断向量表拷贝到 RAM
- 一些频繁访问的常量数据放到 RAM (用 const 修饰的常量是强制放到 rom 或 flash 的)

## 软件优化

- 避免浮点运算
- 采用寄存器操作，不用库函数
- 空间换时间：根据 ADC 值直接查表

## 选择优秀的 IDE

- 不同厂家的开发环境，编译的效率是有差别的，IAR 非常优秀
  - IAR 可以勾选自动内联

## 编译器优化

- 调整编译器优化等级

## 链接器优化

- 自动内联

## 软件调试

- 汇编代码单步执行调试
- 通过汇编代码分析软件执行效率

## 芯片特性方面的优化

- ADC 连续采样：在需要多次采样时，连续采样比分别单次采样功耗低
- 确保各模块时钟在不使用时处于关闭状态
- 确保各管脚在非工作状态下处于高阻状态

## 估算法

- 根据硬件手册的功耗描述，估算软件功耗，与实际功耗比较，评估软件优化方向
- 用内部时钟测量软件运行时间，评估软件优化方向

## 细分法

- 代码要考虑各个功能模块可以单独测试功耗，每增加一个功能，要能分析增加的模块的功耗
- 通过 FCT 测试板子在不同状态下的功耗

## 仪器仪表

- 使用高精度仪器测量微观状态的功耗
- 使用电流表测量平均功耗

## 代码 review

- 邀请同事对代码 review，可能会产生一些优化的方向或者灵感
